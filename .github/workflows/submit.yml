name: Publish browser extension

on:
  workflow_dispatch:
    inputs:
      edge_notes:
        required: false
        default: ''
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: '20'
      CHROME_TARGET: chrome-mv3
      EDGE_TARGET: edge-mv3
      # scegli uno dei due in base al tuo progetto:
      FIREFOX_TARGET: firefox-mv3  # oppure: firefox-mv2

      # percorsi dei file generati da Plasmo (--zip)
      CHROME_ZIP: build/chrome-mv3-prod.zip
      EDGE_ZIP: build/edge-mv3-prod.zip
      FIREFOX_XPI: build/firefox-mv3-prod.zip   # se usi mv2 -> firefox-mv2-prod.zip
      FIREFOX_SOURCE_ZIP: dist/source_${{ github.sha }}.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # ---- Build & zip con Plasmo ----
      - name: Build+zip Chrome
        run: pnpm dlx plasmo build --target=${{ env.CHROME_TARGET }} --zip

      - name: Build+zip Edge
        run: pnpm dlx plasmo build --target=${{ env.EDGE_TARGET }} --zip

      - name: Build+zip Firefox
        run: pnpm dlx plasmo build --target=${{ env.FIREFOX_TARGET }} --zip

      - name: (Opzionale) Crea source zip per AMO
        run: |
          mkdir -p dist
          git archive --format=zip -o "${FIREFOX_SOURCE_ZIP}" HEAD

      # ---- Pubblicazione con BPP ----
      - name: Browser Platform Publisher
        uses: PlasmoHQ/bpp@v3.8.0
        with:
          keys: ${{ secrets.SUBMIT_KEYS }}         # il tuo JSON credenziali
          chrome-file: ${{ env.CHROME_ZIP }}
          edge-file: ${{ env.EDGE_ZIP }}
          firefox-file: ${{ env.FIREFOX_XPI }}    # "file" Ã¨ alias di "zip" anche per FF
          source: ${{ env.FIREFOX_SOURCE_ZIP }}   # alias di sourceZip
          edge-notes: ${{ github.event.inputs.edge_notes }}
          version-file: package.json
          verbose: true
