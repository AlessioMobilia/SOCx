name: Publish browser extension

on:
  workflow_dispatch:
    inputs:
      edge_notes:
        required: false
        default: ''
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: '20'
      CHROME_TARGET: chrome-mv3
      EDGE_TARGET: edge-mv3
      # scegli quello giusto per il tuo progetto:
      FIREFOX_TARGET: firefox  # oppure: firefox-mv2

      # percorsi dei file generati da Plasmo (--zip)
      CHROME_ZIP: build/chrome-mv3-prod.zip
      EDGE_ZIP: build/edge-mv3-prod.zip
      FIREFOX_XPI: build/firefox-prod.zip   # se usi mv2 -> firefox-mv2-prod.zip
      FIREFOX_SOURCE_ZIP: dist/source_${{ github.sha }}.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # come nell'esempio: installa pnpm PRIMA di setup-node
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          # se vuoi far partire subito l'install:
          # run_install: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # ---- Build & zip con Plasmo ----
      - name: Build+zip Chrome
        run: pnpm dlx plasmo build --target=${{ env.CHROME_TARGET }} --zip

      - name: Build+zip Edge
        run: pnpm dlx plasmo build --target=${{ env.EDGE_TARGET }} --zip

      - name: Build+zip Firefox
        run: pnpm dlx plasmo build --target=${{ env.FIREFOX_TARGET }} --zip


      - name: Validate SUBMIT_KEYS JSON
        run: node -e 'JSON.parse(process.env.SUBMIT_KEYS); console.log("SUBMIT_KEYS OK")'
        env:
          SUBMIT_KEYS: ${{ secrets.SUBMIT_KEYS }}

      # ---- Pubblicazione con BPP ----
      - name: Browser Platform Publisher
        uses: PlasmoHQ/bpp@v3.8.0
        with:
          keys: ${{ secrets.SUBMIT_KEYS }}         # JSON credenziali (Chrome/Edge/Firefox)
          chrome-file: ${{ env.CHROME_ZIP }}
          edge-file: ${{ env.EDGE_ZIP }}
          firefox-file: ${{ env.FIREFOX_XPI }}    # accetta .zip per Firefox
          edge-notes: ${{ github.event.inputs.edge_notes }}
          version-file: package.json
          verbose: true
